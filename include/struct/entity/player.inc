    IF !DEF(PLAYER_INC)
    DEF PLAYER_INC EQU 1

INCLUDE "entsys.inc"
INCLUDE "macros/relpointer.inc"
INCLUDE "struct/vram/tower.inc"

DEF ENTVAR_PLAYER_START EQU ENTVAR_DMGCALL_VAR
RSSET ENTVAR_PLAYER_START
DEF ENTVAR_PLAYER_STATE RB 1
DEF ENTVAR_PLAYER_FLAGS RB 1
DEF ENTVAR_PLAYER_XSPEED RB 2
DEF ENTVAR_PLAYER_YSPEED RB 2
DEF ENTVAR_PLAYER_INVINCIBLE RB 1
DEF ENTVAR_PLAYER_TIMER RB 1
DEF ENTVAR_PLAYER_SPRITE RB 1
DEF ENTVAR_PLAYER_ATTR RB 1
DEF ENTVAR_PLAYER_ANIMATION RB 1
DEF ENTVAR_PLAYER_EQUIP RB 4
DEF ENTVAR_PLAYER_WEAPON RB 4
DEF ENTVAR_PLAYER_GRACETIME RB 1

DEF ENTVAR_PLAYER_END RB 0
DEF ENTVAR_PLAYER_COUNT EQU ENTVAR_PLAYER_END - ENTVAR_PLAYER_START
STATIC_ASSERT ENTVAR_PLAYER_END <= 64

; Flags
RSRESET
DEF PLAYER_FLAGF_FACING EQU 1 << _RS
DEF PLAYER_FLAGB_FACING RB 1
DEF PLAYER_FLAGF_INVINCIBLE EQU 1 << _RS
DEF PLAYER_FLAGB_INVINCIBLE RB 1
DEF PLAYER_FLAGF_ARMORED EQU 1 << _RS
DEF PLAYER_FLAGB_ARMORED RB 1
DEF PLAYER_FLAGF_GROUNDED EQU 1 << _RS
DEF PLAYER_FLAGB_GROUNDED RB 1
DEF PLAYER_FLAGF_GRACE EQU 1 << _RS
DEF PLAYER_FLAGB_GRACE RB 1

; States for the big ol' state machine.
RSRESET
DEF PLAYER_STATE_GROUNDED RB 1
DEF PLAYER_STATE_AIRBORNE RB 1
DEF PLAYER_STATE_JUMPSQUAT RB 1
DEF PLAYER_STATE_FIREBREATH RB 1
DEF PLAYER_STATE_STOMPERS_JUMP RB 1
DEF PLAYER_STATE_STOMPERS_SPIN RB 1
DEF PLAYER_STATE_STOMPERS_STOMP RB 1
DEF PLAYER_STATE_STOMPERS_LAND RB 1
DEF PLAYER_STATE_PURCHASE RB 1

DEF PLAYER_FLAGS EQU ENTSYS_FLAGF_COLLISION | ENTSYS_FLAGF_PLAYER
DEF PLAYER_WIDTH EQU $10
DEF PLAYER_HEIGHT EQU $10
DEF PLAYER_BITMASK EQU %11000000
DEF PLAYER_INVINCIBLE_TIME EQU 110
DEF PLAYER_GRACE_TIME EQU 15

DEF PLAYER_XSPEED_MAX EQU $0180
DEF PLAYER_XSPEED_ACCEL_GROUND EQU $30
DEF PLAYER_XSPEED_FRICTION_GROUND EQU $40
DEF PLAYER_XSPEED_ACCEL_AIR EQU $14
DEF PLAYER_XSPEED_FRICTION_AIR EQU $08
DEF PLAYER_GRAVITY EQU $0024

; Sprite tiles.
RSSET VTI_TOWER_PLAYER
DEF PLAYER_SPRITE_IDLE RB 4
DEF PLAYER_SPRITE_WALK1 RB 4
DEF PLAYER_SPRITE_WALK2 RB 4
DEF PLAYER_SPRITE_AIRBORNE_UP RB 4
DEF PLAYER_SPRITE_AIRBORNE_DOWN RB 4
DEF PLAYER_SPRITE_EQUIP RB 12
DEF PLAYER_SPRITE_WEAPON RB 16

; Jump variables.
RSSET PLAYER_SPRITE_EQUIP
DEF PLAYER_SPRITE_JUMP_JUMPSQUAT RB 4

DEF PLAYER_JUMPSQUAT_TIME EQU 8
DEF PLAYER_JUMP_STRENGTH EQU $0260

; Firebreath variables.
RSSET PLAYER_SPRITE_WEAPON
DEF PLAYER_SPRITE_FIREBREATH_INHALE RB 4
DEF PLAYER_SPRITE_FIREBREATH_EXHALE RB 4
DEF PLAYER_SPRITE_FIREBREATH_BALL1 RB 4
DEF PLAYER_SPRITE_FIREBREATH_BALL2 RB 4

DEF PLAYER_FIREBREATH_TIME EQU 38
DEF PLAYER_FIREBREATH_TIME_SUMMON EQU 23

; Jetpack variables.
RSSET ENTVAR_PLAYER_EQUIP
DEF ENTVAR_PLAYER_JETPACK_FUEL RB 1
DEF ENTVAR_PLAYER_JETPACK_USE RB 1
DEF ENTVAR_PLAYER_JETPACK_TICK RB 1

RSSET PLAYER_SPRITE_EQUIP
DEF PLAYER_SPRITE_JETPACK_FUEL RB 10
DEF PLAYER_SPRITE_JETPACK_PARTICLE RB 2

DEF PLAYER_JETPACK_FUEL_MAX EQU 60
DEF PLAYER_JETPACK_YSPEED EQU -$0131
DEF PLAYER_JETPACK_USETIME EQU 45

; Stomper variables.
RSSET PLAYER_SPRITE_WEAPON
DEF PLAYER_SPRITE_STOMPERS_FALL1 RB 4
DEF PLAYER_SPRITE_STOMPERS_FALL2 RB 4
DEF PLAYER_SPRITE_STOMPERS_ROTATE RB 4
DEF PLAYER_SPRITE_STOMPERS_LAND RB 4

DEF PLAYER_STOMPERS_FLAGS EQU PLAYER_FLAGS | ENTSYS_FLAGF_DMGCALL | ENTSYS_FLAGF_DAMAGE
DEF PLAYER_STOMPERS_SPIN_TIME EQU 16
DEF PLAYER_STOMPERS_LAND_TIME EQU 12
DEF PLAYER_YSPEED_STOMPERS_JUMP EQU -$0321
DEF PLAYER_YSPEED_STOMPERS_STOMP EQU $046A
DEF PLAYER_YSPEED_STOMPERS_BOUNCE EQU -$0282
DEF PLAYER_XSPEED_STOMPERS_ACCEL EQU $0016



; Initializes relative pointer.
;
; Input:
; - `hl`: Player entity pointer (anywhere)
; - `1`: Start position
;
; Destroys: `af`, `l`
MACRO player_relpointer_init
    ld a, l
    and a, PLAYER_BITMASK
    or a, \1
    ld l, a
    relpointer_init l, \1
ENDM

    ENDC

    IF !DEF(PLAYER_INC)
    DEF PLAYER_INC EQU 1

INCLUDE "entsys.inc"
INCLUDE "macros/relpointer.inc"
INCLUDE "struct/vram/tower.inc"

DEF ENTVAR_PLAYER_START EQU ENTVAR_COL_VAR
RSSET ENTVAR_PLAYER_START
DEF ENTVAR_PLAYER_STATE RB 1
DEF ENTVAR_PLAYER_FLAGS RB 1
DEF ENTVAR_PLAYER_XSPEED RB 2
DEF ENTVAR_PLAYER_YSPEED RB 2
DEF ENTVAR_PLAYER_INVINCIBLE RB 1
DEF ENTVAR_PLAYER_TIMER RB 1
DEF ENTVAR_PLAYER_SPRITE RB 1
DEF ENTVAR_PLAYER_ANIMATION RB 1
DEF ENTVAR_PLAYER_EQUIP RB 4
DEF ENTVAR_PLAYER_WEAPON RB 4

DEF ENTVAR_PLAYER_END RB 0
DEF ENTVAR_PLAYER_COUNT EQU ENTVAR_PLAYER_END - ENTVAR_PLAYER_START
ASSERT ENTVAR_PLAYER_END <= 32

; Flags
RSRESET
DEF PLAYER_FLAGF_FACING EQU 1 << _RS
DEF PLAYER_FLAGB_FACING RB 1
DEF PLAYER_FLAGF_INVINCIBLE EQU 1 << _RS
DEF PLAYER_FLAGB_INVINCIBLE RB 1
DEF PLAYER_FLAGF_GROUNDED EQU 1 << _RS
DEF PLAYER_FLAGB_GROUNDED RB 1

; States for the big ol' state machine.
RSRESET
DEF PLAYER_STATE_GROUNDED RB 1
DEF PLAYER_STATE_AIRBORNE RB 1
DEF PLAYER_STATE_JUMPSQUAT RB 1
DEF PLAYER_STATE_LANDING RB 1
DEF PLAYER_STATE_FIREBREATH RB 1

DEF PLAYER_WIDTH EQU $10
DEF PLAYER_HEIGHT EQU $10
DEF PLAYER_BITMASK EQU %11100000
DEF PLAYER_INVINCIBLE_TIME EQU 110
DEF PLAYER_JUMPSQUAT_TIME EQU 8
DEF PLAYER_JUMP_STRENGTH EQU $0260
DEF PLAYER_FIREBREATH_TIME EQU 38
DEF PLAYER_FIREBREATH_TIME_SUMMON EQU 23

DEF PLAYER_XSPEED_MAX EQU $0180
DEF PLAYER_XSPEED_ACCEL_GROUND EQU $30
DEF PLAYER_XSPEED_FRICTION_GROUND EQU $40
DEF PLAYER_XSPEED_ACCEL_AIR EQU $14
DEF PLAYER_XSPEED_FRICTION_AIR EQU $08
DEF PLAYER_GRAVITY EQU $0024

; Jetpack variables.
RSSET ENTVAR_PLAYER_EQUIP
DEF ENTVAR_PLAYER_JETPACK_FUEL RB 1
DEF ENTVAR_PLAYER_JETPACK_USE RB 1
DEF ENTVAR_PLAYER_JETPACK_TICK RB 1

DEF PLAYER_JETPACK_FUEL_MAX EQU 60
DEF PLAYER_JETPACK_YSPEED EQU -$0131
DEF PLAYER_JETPACK_USETIME EQU 26

; Sprite tiles.
RSSET VTI_TOWER_PLAYER
DEF PLAYER_SPRITE_IDLE RB 4
DEF PLAYER_SPRITE_WALK1 RB 4
DEF PLAYER_SPRITE_WALK2 RB 4
DEF PLAYER_SPRITE_AIRBORNE_UP RB 4
DEF PLAYER_SPRITE_AIRBORNE_DOWN RB 4
DEF PLAYER_SPRITE_EQUIP RB 12
DEF PLAYER_SPRITE_WEAPON RB 16

; Jump tiles.
RSSET PLAYER_SPRITE_EQUIP
DEF PLAYER_SPRITE_JUMP_JUMPSQUAT RB 4

; Firebreath tiles.
RSSET PLAYER_SPRITE_WEAPON
DEF PLAYER_SPRITE_FIREBREATH_INHALE RB 4
DEF PLAYER_SPRITE_FIREBREATH_EXHALE RB 4
DEF PLAYER_SPRITE_FIREBREATH_BALL1 RB 4
DEF PLAYER_SPRITE_FIREBREATH_BALL2 RB 4

; Jetpack tiles
RSSET PLAYER_SPRITE_EQUIP
DEF PLAYER_SPRITE_JETPACK_FUEL RB 10
DEF PLAYER_SPRITE_JETPACK_PARTICLE RB 2



; Initializes relative pointer.
;
; Input:
; - `hl`: Player entity pointer (anywhere)
; - `1`: Start position
;
; Destroys: `af`, `l`
MACRO player_relpointer_init
    ld a, l
    and a, PLAYER_BITMASK
    or a, \1
    ld l, a
    relpointer_init l, \1
ENDM

    ENDC

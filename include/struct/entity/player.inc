INCLUDE "entsys.inc"
INCLUDE "struct/vram/tower.inc"

DEF ENTVAR_PLAYER_START EQU ENTVAR_COL_VAR
RSSET ENTVAR_PLAYER_START
DEF ENTVAR_PLAYER_STATE RB 1
DEF ENTVAR_PLAYER_FLAGS RB 1
DEF ENTVAR_PLAYER_XSPEED RB 2
DEF ENTVAR_PLAYER_YSPEED RB 2
DEF ENTVAR_PLAYER_INVINCIBLE RB 1
DEF ENTVAR_PLAYER_TIMER RB 1
DEF ENTVAR_PLAYER_SPRITE RB 1
DEF ENTVAR_PLAYER_ANIMATION RB 1

DEF ENTVAR_PLAYER_END RB 0
DEF ENTVAR_PLAYER_COUNT EQU ENTVAR_PLAYER_END - ENTVAR_PLAYER_START
ASSERT ENTVAR_PLAYER_END <= 32

RSRESET
DEF PLAYER_FLAGF_FACING EQU 1 << _RS
DEF PLAYER_FLAGB_FACING RB 1
DEF PLAYER_FLAGF_INVINCIBLE EQU 1 << _RS
DEF PLAYER_FLAGB_INVINCIBLE RB 1

RSRESET
DEF PLAYER_STATE_GROUNDED RB 1
DEF PLAYER_STATE_AIRBORNE RB 1
DEF PLAYER_STATE_JUMPSQUAT RB 1
DEF PLAYER_STATE_LANDING RB 1

DEF PLAYER_WIDTH EQU $10
DEF PLAYER_HEIGHT EQU $10
DEF PLAYER_BITMASK EQU %11100000
DEF PLAYER_INVINCIBLE_TIME EQU 110
DEF PLAYER_JUMPSQUAT_TIME EQU 8
DEF PLAYER_JUMP_STRENGTH EQU $0260

DEF PLAYER_XSPEED_MAX EQU $0180
DEF PLAYER_XSPEED_ACCEL_GROUND EQU $30
DEF PLAYER_XSPEED_FRICTION_GROUND EQU $40
DEF PLAYER_XSPEED_ACCEL_AIR EQU $14
DEF PLAYER_XSPEED_FRICTION_AIR EQU $08
DEF PLAYER_GRAVITY EQU $0024

RSSET VTI_TOWER_PLAYER
DEF PLAYER_SPRITE_IDLE RB 4
DEF PLAYER_SPRITE_WALK1 RB 4
DEF PLAYER_SPRITE_WALK2 RB 4
DEF PLAYER_SPRITE_JUMPSQUAT RB 4
DEF PLAYER_SPRITE_AIRBORNE_UP RB 4
DEF PLAYER_SPRITE_AIRBORNE_DOWN RB 4

; Initializes relative pointer.
;
; Input:
; - `hl`: Player entity pointer (anywhere)
; - `1`: Start position
;
; Destroys: `af`, `l`
MACRO player_relpointer_init
    ld a, l
    and a, PLAYER_BITMASK
    or a, \1
    ld l, a
    relpointer_init l, \1
ENDM
